"use strict";!function(e){void 0===e.detectOS&&(e.detectOS={Windows:-1!==navigator.platform.indexOf("Win"),MacOS:-1!==navigator.platform.indexOf("Mac"),Linux:-1!==navigator.platform.indexOf("Linux"),Unix:-1!==navigator.platform.indexOf("X11"),OS:null},e.detectOS.Windows?e.detectOS.OS="Windows":e.detectOS.Linux?e.detectOS.OS="Linux":e.detectOS.MacOS?e.detectOS.OS="MacOS":e.detectOS.UNIX&&(e.detectOS.OS="Unix"))}(jQuery),function(e){function t(e,t){var i="";return"msoffice"===t?i=function(e){switch(function(e){var t,i=e.indexOf("?");i>-1&&(e=e.substr(0,i));if(t=e.split("."),1===t.length)return"";return t.pop()}(e).toLowerCase()){case"docx":case"doc":case"docm":case"dot":case"dotm":case"dotx":case"odt":return"ms-word";case"xltx":case"xltm":case"xlt":case"xlsx":case"xlsm":case"xlsb":case"xls":case"xll":case"xlam":case"xla":case"ods":return"ms-excel";case"pptx":case"pptm":case"ppt":case"ppsx":case"ppsm":case"pps":case"ppam":case"ppa":case"potx":case"potm":case"pot":case"odp":return"ms-powerpoint";case"accdb":case"mdb":return"ms-access";case"xsn":case"xsf":return"ms-infopath";case"pub":return"ms-publisher";case"vstx":case"vstm":case"vst":case"vssx":case"vssm":case"vss":case"vsl":case"vsdx":case"vsdm":case"vsd":case"vdw":return"ms-visio";case"mpp":case"mpt":return"ms-project";default:return""}}(e)+":ofe|u|":"libreoffice"===t?i="vnd.libreoffice.command:":"openoffice"===t&&(i="vnd.sun.star.webdav:"),e=i+e.replace(/^.*:/,window.location.protocol)}e((function(){e(".jqWebDAVLink").livequery((function(){var i=e(this);(e.detectOS.Windows||e.detectOS.MacOS)&&i.on("click",(function(){var n=t(i.attr("href"),foswiki.getPreference("TopicInteractionPlugin").officeSuite);return e("<iframe />").hide().attr("src",n).appendTo("body"),!1}))}))}))}(jQuery),function(e){var t={showHidden:!1,showOptions:!1,showEmpty:!1,sort:"name",filter:"",limit:6,skip:0,cols:1,debug:!1};function i(i,n){var o=this;o.elem=e(i),o.opts=e.extend({},t,o.elem.data(),n),o.log("new FoswikiAttachments opts=",o.opts),o.init()}i.prototype.log=function(){var t;console&&this.opts.debug&&((t=e.makeArray(arguments)).unshift("FA:"),console.log.apply(console,t))},i.prototype.init=function(){var t,i=this;i.log("called init()"),i.container=i.elem.parent(),i.optionsButton=i.elem.find(".foswikiAttachmentsOptionsToggle"),i.optionsLabel=i.optionsButton.find("span:last")||i.optionsButton,i.toggleContainer=i.elem.find(".foswikiAttachmentsOptionsToggleContainer"),i.toggleOpts=e.extend({},i.optionsButton.metadata(),i.optionsButton.data()),i.pager=i.elem.find(".foswikiAttachmentsPager"),i.selection=[],void 0!==i.opts.selection&&""!==i.opts.selection&&e.each(i.opts.selection.split(/\s*,\s*/),(function(e,t){void 0!==i.getAttachmentData(t)&&i.select(t)})),i.elem.parent().parent().parent().each((function(){t=e(this).data("tabPane")})),t&&(i.opts.showEmpty||i.getCount()>0?(i.elem.find(".foswikiAttachmentsSelectAll").show(),t.showTab(".attachments"),1===t.elem.find(">.jqTab").length&&t.switchTab(".attachments")):t.hideTab(".attachments")),i.displayAttachmentsCount(),i.showSelection(),i.elem.on("refresh",(function(t,n){return i.log("got refresh event"),n&&(i.log("refreshing from files",n),i.clearSelection(),e.each(n,(function(e,t){"string"==typeof t?i.select(t,!0):i.select(t.name,!0)}))),i.load(),!1})),i.optionsButton.on("click",(function(){return i.toggleContainer.is(":visible")?i.hideOptionsContainer():i.showOptionsContainer(),!1})),i.elem.find(".foswikiDisplayHidden input").on("change",(function(){return i.load({showempty:!0,showhidden:e(this).prop("checked")}),!1})),i.elem.find(".foswikiFilter input").on("keypress",(function(t){var n,o=e(this);if(13===t.keyCode)return"none"===(n=o.val())&&(n=""),i.load({showempty:!0,filter:n}),t.preventDefault(),!1})),i.elem.find(".foswikiSortBy select").on("change",(function(){var t=e(this).val();return i.load({skip:0,sort:t,reverse:"date"===t}),!1})),i.elem.find(".foswikiResultsPerPage select").on("change",(function(){var t=e(this);return i.load({skip:0,limit:t.val()}),!1})),i.pager.find("a").on("click",(function(){var t=e(this);return i.load({skip:i.getSkip(t)}),!1})),i.elem.find(".foswikiAttachment").on("mouseenter",(function(){e(this).addClass("foswikiAttachmentHover")})).on("mouseleave",(function(){e(this).removeClass("foswikiAttachmentHover")})).on("click",(function(t){var n=e(this),o=n.data("id");if(!e(t.target).is("a,img,i"))return n.toggleClass("foswikiSelected"),n.hasClass("foswikiSelected")?i.select(o):i.clear(o),t.stopPropagation(),!1})).find(".foswikiAttachmentSelect").on("click",(function(t){var n=e(this).parents(".foswikiAttachment:first"),o=n.data("id");return n.toggleClass("foswikiSelected"),n.hasClass("foswikiSelected")?i.select(o):i.clear(o),t.stopPropagation(),!1})),i.elem.find(".foswikiAttachmentsSelectAll").on("click",(function(){return i.log("clicked select all"),i.selection=[],i.elem.find("input.foswikiAttachmentsAll").each((function(){i.selection.push(e(this).data("id"))})),e(this).hide(),i.showSelection(),!1})),i.elem.find(".foswikiAttachmentsClearAll").on("click",(function(){return i.clearSelection(),i.elem.find(".foswikiAttachmentsSelectAll").show(),!1})),i.elem.find(".foswikiAttachmentPreviewButton").on("click",(function(){var t,n=e(this).parents(".foswikiAttachment:first"),o=i.getAttachmentData(n),a=o.filename.replace(/^.+\./,"");return t=a.match(/mp3|wav/)?"audio":a.match(/mp4|mkv|mpe?g|mov|ogg|webm|ogv/)?"video":a.match(/vsd/)?"visio":"document",e.blockUI({message:"<h1>"+e.i18n("Loading preview ...")+"</h1>",fadeIn:0,fadeOut:0}),Dialog.load({expand:"attachments::previewer::"+t,data:{filename:decodeURIComponent(o.filename)}}).done((function(t){e.unblockUI(),t.parent().find(".ui-dialog-title").text(decodeURIComponent(o.filename))})),!1})),i.elem.find(".foswikiAttachmentDeleteButton").on("click",(function(){var t=e(this).parents(".foswikiAttachment:first"),n=i.getAttachmentData(t),o=t.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");return Dialog.load({id:"#foswikiAttachmentConfirmDelete",expand:"attachments::confirmdelete",init:function(){var e=this;e.find("#deleteAttachment").text(decodeURIComponent(n.filename)),e.find("input[name=filename]").val(decodeURIComponent(n.filename)),0===o.find(".foswikiAlert").length&&e.find(".foswikiThumbnailContainer").html(o),e.dialog("option","position","center")}}),!1})),i.elem.find(".foswikiAttachmentEditButton").on("click",(function(e){e.stopPropagation()})),i.elem.find(".foswikiAttachmentPropertiesButton").on("click",(function(){var t=e(this).parents(".foswikiAttachment:first"),n=i.getAttachmentData(t),o=t.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");return Dialog.load({id:"#foswikiAttachmentEditor",expand:"attachments::editor",init:function(){var e=this,t=e.find("input[name=hidefile]"),i=e.find("input[name=isthumbnail]");e.find("input[name=origfilename]").val(decodeURIComponent(n.filename)),e.find("input[name=filename]").val(decodeURIComponent(n.filename)),e.find("input[name=filecomment]").val(decodeURIComponent(n.filecomment)),0===o.find(".foswikiAlert").length&&e.find(".foswikiThumbnailContainer").html(o),n.filename.match(/\.(gif|jpe?g|png|bmp|svg|webp|pdf|tiff?|avif)$/i)?e.find(".foswikiThumbnailStep").show():e.find(".foswikiThumbnailStep").hide(),n.fileattr.match(/h/)?t.prop("checked",!0):t.prop("checked",!1),n.fileattr.match(/t/)?i.prop("checked",!0):i.prop("checked",!1),e.dialog("option","position","center")}}),!1})),i.elem.find(".foswikiAttachmentMoveButton").on("click",(function(){var t=e(this).parents(".foswikiAttachment:first"),n=i.getAttachmentData(t),o=t.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");return Dialog.load({id:"#foswikiAttachmentMove",expand:"attachments::moveattachment",init:function(){var e=this;e.find("input[name=filename]").val(decodeURIComponent(n.filename)),e.find("input[name=newfilename]").val(decodeURIComponent(n.filename)),0===o.find(".foswikiAlert").length&&e.find(".foswikiThumbnailContainer").html(o),e.find(".foswikiGenericThumbnail").hide(),n.movedFromName&&n.movedFromWeb&&n.movedFromTopic?e.find(".foswikiMovedFromStep").show():e.find(".foswikiMovedFromStep").remove(),e.find(".foswikiMovedFromStep input[name=restore]:not(.inited)").addClass("inited").on("click",(function(){var t,o,a;this.checked?(t=decodeURIComponent(n.movedFromName),o=decodeURIComponent(n.movedFromWeb),a=decodeURIComponent(n.movedFromTopic)):(t=decodeURIComponent(n.filename),o=decodeURIComponent(n.web),a=decodeURIComponent(n.topic)),i.log("fileName=",t,"web=",o,"topic=",a),e.find("input[name=newfilename]").val(t),e.find("input[name=newweb]").val(o),e.find("input[name=newtopic]").val(a)})),e.dialog("option","position","center")}}),!1})),i.elem.find(".foswikiAttachmentsBulkAction select").on("change",(function(){var t,n=e(this),o=n.val(),a="",s=i.selection?i.selection.length:0;if(s&&o){if(n.val(""),"createlink"===o)t=".foswikiAttachmentBulkCreateLinks",a="file";else if("embed"===o)t=".foswikiAttachmentBulkEmbed",o="createlink",a="";else if("createimagegallery"===o)t=".foswikiAttachmentBulkCreateImageGallery";else if("download"===o)t=".foswikiAttachmentBulkDownload";else if("hide"===o)t=".foswikiAttachmentBulkHide";else if("unhide"===o)t=".foswikiAttachmentBulkUnHide";else if("delete"===o)t=".foswikiAttachmentBulkDelete";else if("move"!==o)return void alert("unknown action "+o);"move"!==o?Dialog.load({id:"#foswikiAttachmentConfirmBulk",expand:"attachments::confirmbulkaction",init:function(){var n=this,c=n.find("form"),l="";c.find("input[type='hidden'][name='filename']").remove(),e.each(i.selection,(function(t,n){var o=i.getAttachmentData(n);void 0!==o&&e("<input type='hidden' name='filename' />").val(decodeURIComponent(o.filename)).prependTo(c),l=o.fileattr.match(/h/)?""===l||"h"===l?"h":"?":""===l||"v"===l?"v":"?"})),"?"===l?n.find("input[name=hidefile]").parent().remove():"h"===l?n.find("input[name=hidefile]").prop("checked",!0):"v"===l&&n.find("input[name=hidefile]").prop("checked",!1),n.find("input[name='action']").val(o),n.find("input[name='type']").val(a),c.attr("action",foswiki.getScriptUrl("rest","TopicInteractionPlugin",o)),n.find(".foswikiAttachmentBulkMessage").hide(),n.find(t).show().find(".count").text(s),n.dialog("option","position","center")}}):Dialog.load({id:"#foswikiAttachmentMove",expand:"attachments::moveattachment",init:function(){var t=this,n=t.find("form");n.find("input[type='hidden'][name='filename']").remove(),e.each(i.selection,(function(t,o){var a=i.getAttachmentData(o);void 0!==a&&e("<input type='hidden' name='filename' />").val(decodeURIComponent(a.filename)).prependTo(n)})),t.find(".foswikiAttachmentsCount").text(i.selection.length),t.find(".foswikiThumbnailContainer").empty(),t.find(".foswikiGenericThumbnail").show(),t.dialog("option","position","center")}})}})),i.elem.find(".foswikiShowVersions").each((function(){var t=e(this),n=t.parents(".foswikiAttachment:first"),o=i.getAttachmentData(n),a=n.find(".foswikiVersionsContainer"),s=foswiki.getScriptUrl("rest","RenderPlugin","template"),c={name:"metadata",render:"on",topic:decodeURIComponent(i.opts.topic),expand:"attachments::versions",attachment:o.filename};t.on("click",(function(){return a.is(".foswikiVersionsContainerLoaded")?(t.hide(),n.find(".foswikiHideVersions").show(),a.slideDown("fast")):(a.show(),a.load(s,c,(function(){a.addClass("foswikiVersionsContainerLoaded"),n.effect("highlight"),t.hide(),n.find(".foswikiHideVersions").show()}))),!1}))})),i.elem.find(".foswikiHideVersions").each((function(){var t=e(this),i=t.parents(".foswikiAttachment:first"),n=i.find(".foswikiVersionsContainer");t.on("click",(function(){return t.hide(),i.find(".foswikiShowVersions").show(),n.slideUp("fast"),!1}))})),e("#foswikiAttachmentEditorForm").livequery((function(){var t=e(this);t.ajaxForm({dataType:"json",beforeSerialize:function(){"undefined"!=typeof foswikiStrikeOne&&foswikiStrikeOne(t[0])},beforeSubmit:function(){t.parent().dialog("close"),e.blockUI({message:"<h1>"+e.i18n("Saving changes ...")+"</h1>",fadeIn:0,fadeOut:0})},success:function(){e.unblockUI(),i.load()},error:function(t,i){try{i=e.parseJSON(t.responseText).error.message}catch(e){}e.unblockUI(),e.pnotify({title:e.i18n("Edit failed"),text:i,type:"error"})}})})),e("#foswikiAttachmentConfirmDeleteForm").livequery((function(){var t,n=e(this);n.ajaxForm({dataType:"json",beforeSerialize:function(){"undefined"!=typeof foswikiStrikeOne&&foswikiStrikeOne(n[0])},beforeSubmit:function(){n.parent().dialog("close"),t=n.find("input[name='filename']").val(),e.blockUI({message:"<h1>"+e.i18n("Deleting ...")+"</h1> <div class='noBreakout'>"+t+"</div>",fadeIn:0,fadeOut:0})},success:function(){e.unblockUI(),i.clear(t),i.load()},error:function(i,n){try{n=e.parseJSON(i.responseText).error.message}catch(e){}e.unblockUI(),e.pnotify({title:e.i18n("Failed to delete %file%",{file:t}),text:n,type:"error"})}})})),e("#foswikiAttachmentMoveForm").livequery((function(){var t=e(this);t.ajaxForm({dataType:"json",beforeSerialize:function(){"undefined"!=typeof foswikiStrikeOne&&foswikiStrikeOne(t[0])},beforeSubmit:function(){t.parent().dialog("close"),e.blockUI({message:"<h1>"+e.i18n("Moving attachment(s) ...")+"</h1>",fadeIn:0,fadeOut:0})},success:function(){e.unblockUI(),i.clearSelection(),i.load()},error:function(t,i){try{i=e.parseJSON(t.responseText).error.message}catch(e){}e.unblockUI(),e.pnotify({title:e.i18n("Move failed"),text:i,type:"error"})}})})),e("#foswikiAttachmentConfirmBulkForm").livequery((function(){var t,n,o=e(this);o.ajaxForm({dataType:"json",beforeSerialize:function(){"undefined"!=typeof foswikiStrikeOne&&foswikiStrikeOne(o[0])},beforeSubmit:function(){t=o.find(".foswikiAttachmentBulkMessage:visible .foswikiAttachmentBulkProgressMessage").html(),n=o.find("input[name='action']").val(),o.parent().dialog("close"),e.blockUI({message:"<h1>"+t+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(t){e.unblockUI(),"createlink"===n||"createimagegallery"===n||"embed"===n?window.location.reload():"download"===n?window.location.href=t.result:(i.clearSelection(),i.load())},error:function(t,i){try{i=e.parseJSON(t.responseText).error.message}catch(e){}e.unblockUI(),e.pnotify({title:e.i18n("Error during '%action%'",{action:n}),text:i,type:"error"})}})}))},i.prototype.getCount=function(){return this.pager.length?this.pager.data("count"):0},i.prototype.getSkip=function(e){return(e=e||this.pager.find("a.current")).length?e.data("skip"):0},i.prototype.getAttachmentData=function(t){var i;return"string"==typeof t?t=e(i=t):i=t.data("id"),e("#data_"+i).data()},i.prototype.displayAttachmentsCount=function(){var e=this,t=e.getCount();return t?e.elem.parents(".foswikiMetaData:first").find(".foswikiAttachmentsCount").text(t).show():e.elem.parents(".foswikiMetaData:first").find(".foswikiAttachmentsCount").text("").hide(),t},i.prototype.load=function(t){var i,n=this,o={},a=e.Deferred();return n.log("called load()"),e.each(t,(function(e,t){o["attachments_"+e]=t})),t=e.extend({name:"metadata",render:"on",cachecontrol:0,topic:decodeURIComponent(n.opts.topic),expand:"attachments",attachments_showhidden:n.opts.showHidden,attachments_showoptions:n.opts.showOptions,attachments_showempty:n.opts.showEmpty,attachments_sort:n.opts.sort,attachments_reverse:"date"===n.opts.sort,attachments_filter:encodeURI(n.opts.filter),attachments_limit:n.opts.limit,attachments_skip:n.getSkip(),attachments_cols:n.opts.cols,attachments_selection:n.selection.join(", ")},o),i=foswiki.getScriptUrl("rest","RenderPlugin","template"),n.elem.block({message:null,fadeIn:0,fadeOut:0,overlayCSS:{cursor:"progress"}}),n.container.load(i,t,(function(){n.elem.unblock(),n.container.height("auto"),n.elem.removeData("FoswikiAttachments"),a.resolve()})),a.promise()},i.prototype.showSelection=function(){var t,i,n=this;if(n.log("showSelection",n.selection),n.elem.find(".foswikiSelected").removeClass("foswikiSelected"),n.selection){for(t=0;t<n.selection.length;t++)i=n.selection[t],e("#attachment_"+i).addClass("foswikiSelected");n.selection.length?(n.elem.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").show(),n.elem.find(".foswikiAttachmentsSelected").text(n.selection.length)):n.elem.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").hide()}else n.elem.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").hide()},i.prototype.select=function(e,t){var i=this;e&&(e=e.replace(/[^0-9a-zA-Z_]/g,"_"),void 0===i.selection&&(i.selection=[]),i.selection.push(e),t||(i.selection.length===i.getCount()&&i.elem.find(".foswikiAttachmentsSelectAll").hide(),i.showSelection()))},i.prototype.clear=function(e){var t=this;if(t.selection)for(var i=0;i<t.selection.length;i++)if(t.selection[i]===e){t.selection.splice(i,1);break}t.elem.find(".foswikiAttachmentsSelectAll").show(),t.showSelection()},i.prototype.clearSelection=function(){this.selection=[],this.showSelection()},i.prototype.hideOptionsContainer=function(){var t=this;t.optionsLabel.html(e.i18n("Show options")),t.toggleContainer.slideUp({easing:"easeInOutQuad",duration:"fast"}),t.opts.showOptions=!1},i.prototype.showOptionsContainer=function(){var t=this;t.optionsLabel.html(e.i18n("Hide options")),t.toggleContainer.slideDown({easing:"easeInOutQuad",duration:"fast"}),t.opts.showOptions=!0},e((function(){e(".foswikiAttachments.foswikiFormSteps").livequery((function(){var t=e(this);void 0===t.data("foswikiAttachments")&&t.data("foswikiAttachments",new i(this)),e(".foswikiMetaData").show()}))}))}(jQuery);
